# WebSocket и RabbitMQ на FastAPI

### Описание проекта

Данный проект демонстрирует использование WebSocket-соединений для работы с клиентами и интеграцию с RabbitMQ для обмена сообщениями. Он включает:

 - Создание и проверку JWT-токенов для аутентификации пользователей.

- WebSocket-соединения для взаимодействия клиентов с комнатами.

- RabbitMQ для обработки очередей сообщений.

- Postman для тестирования API.

- Swagger для документирования и тестирования REST API.


### Функциональность

#### 1. Создание токена

- Токен генерируется через эндпоинт POST /generate-token.

- Пользователь отправляет JSON с данными:

```
{
  "username": "user1",
  "email": "user1@example.com",
  "room_id": "room1"
}
```

Сервер создает JWT-токен, который содержит:

- Имя пользователя (username). 

- Email пользователя (email).

- Идентификатор комнаты (room_id).

- Срок действия токена (exp) — 1 час.

Пример ответа:

```
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

#### 2. Проверка токена

- При подключении по WebSocket клиент отправляет токен в заголовке Authorization в формате Bearer <токен>.

- Токен проверяется через:

    - Наличие и корректность подписи (с использованием секретного ключа SECRET_KEY).

    - Срок действия (exp).

Если токен недействителен или истек, соединение отклоняется.

#### 3. WebSocket-соединение

- Клиент подключается по WebSocket к адресу:

    ws://localhost:8000/updates/{room_id}

    где {room_id} — это идентификатор комнаты.

- После проверки токена сервер:

    - Создает комнату, если она не существует.

    - Проверяет, что в комнате не более двух уникальных пользователей.

    - Подключает клиента к комнате и добавляет его в список активных соединений.

#### 4. Отправка сообщений

- Эндпоинт POST /message позволяет клиенту отправить сообщение в очередь RabbitMQ.

- JSON для отправки:

```
{
  "room_id": "room1",
  "content": "Hello, Room!"
}
```

- Сообщение публикуется в очередь messages.

Пример ответа:

```
{
  "status": "Message sent to room: room1"
}
```

#### 5. Подписка и отправка сообщений

- Сервер подписан на очередь messages через декоратор @router.subscriber(queue="messages").

- Когда новое сообщение попадает в очередь messages, сервер:

    - Проверяет, есть ли активные WebSocket-соединения для указанной комнаты (room_id).

    - Отправляет сообщение всем подключенным пользователям в комнате.

### Как развернуть проект

#### 1. Установка зависимостей

Установите все зависимости:

```
pip install -r requirements.txt
```

#### 2. Запуск RabbitMQ

Запустите RabbitMQ через Docker:

```
docker run -d --name rabbitmq -p 5672:5672 -p 15672:15672 rabbitmq:management
```

Панель управления RabbitMQ доступна по адресу:

http://localhost:15672

(Логин/пароль: guest/guest).


#### 3. Запуск сервера FastAPI

Запустите приложение:

```
uvicorn app.main:app --reload
```

- Swagger-документация будет доступна по адресу:

http://localhost:8000/docs

#### 4. Тестирование в Postman

1. Генерация токена

- Метод: POST

- URL: http://localhost:8000/generate-token

- Тело запроса:

```
{
  "username": "user1",
  "email": "user1@example.com",
  "room_id": "room1"
}
```

- Ответ:
JWT-токен для пользователя.

2. Подключение по WebSocket

- Используйте токен для подключения:

    - URL: ws://localhost:8000/updates/room1

    - Заголовок: Authorization: Bearer <ваш токен>

3. Отправка сообщений

- Метод: POST

- URL: http://localhost:8000/message

- Тело запроса:

```
{
  "room_id": "room1",
  "content": "Hello, Room!"
}
```

- Сообщение "Hello, Room!" должно доставиться всем клиентам, подключенным к комнате room1.

